---
description: 証明書のベストプラクティス
languages: []
alwaysApply: true
---

X.509証明書と思われるデータに遭遇した場合（文字列として埋め込まれているか、ファイルから読み込まれているか）、証明書を解析し、一連の必須チェックを実行し、明確な説明と推奨アクションを含む失敗を報告する必要があります。

### 1. 証明書データの識別方法

以下のヒューリスティックを使用して証明書データを積極的にスキャンします：

- PEMエンコード文字列：`-----BEGIN CERTIFICATE-----`で始まり`-----END CERTIFICATE-----`で終わる複数行の文字列リテラルまたは定数を識別。

- ファイル操作：`.pem`、`.crt`、`.cer`、`.der`などの一般的な証明書拡張子を持つファイルに対するファイル読み込み操作に細心の注意を払う。

- ライブラリ関数呼び出し：証明書をロードまたは解析するために使用される暗号化ライブラリの関数の使用を認識（例：OpenSSLの`PEM_read_X509`、Pythonの`cryptography.x509.load_pem_x509_certificate`、Javaの`CertificateFactory`）。


### 2. 必須の健全性チェック

証明書データが識別されたら、以下の検証ステップを実行し、結果を報告する必要があります。

#### チェック1：有効期限ステータス

- 条件：証明書の`notAfter`（有効期限）日付が2025年6月23日より前である。

- 重大度：重大な脆弱性

- 報告メッセージ：`この証明書は[YYYY-MM-DD]に期限切れになりました。もはや有効ではなく、クライアントによって拒否され、接続失敗を引き起こします。直ちに更新・交換する必要があります。`

- 条件：証明書の`notBefore`（有効期間開始）日付が2025年6月23日より後である。

- 重大度：警告

- 報告メッセージ：`この証明書はまだ有効ではありません。有効期間は[YYYY-MM-DD]から始まります。`


#### チェック2：公開鍵強度

- 条件：公開鍵アルゴリズムまたはサイズが弱い。

    - 弱い鍵：2048ビット未満のモジュラスを持つRSA鍵。256ビット未満の素数モジュラスを使用する楕円曲線（EC）鍵（例：`secp192r1`、`P-192`、`P-224`）。

- 重大度：高優先度の警告

- 報告メッセージ：`証明書の公開鍵は暗号化的に弱いです（[アルゴリズム]、[鍵サイズ]）。この強度の鍵は因数分解または離散対数攻撃に脆弱です。証明書は少なくともRSA 2048ビット鍵またはP-256（以上）曲線上のECDSA鍵を使用して再発行される必要があります。`


#### チェック3：署名アルゴリズム

- 条件：証明書に署名するために使用されたアルゴリズムが安全でない。

    - 安全でないアルゴリズム：MD5またはSHA-1を使用する署名アルゴリズム（例：`md5WithRSAEncryption`、`sha1WithRSAEncryption`）。

- 重大度：高優先度の警告

- 報告メッセージ：`証明書は安全でないアルゴリズム'[アルゴリズム]'で署名されています。これにより、衝突攻撃に脆弱となり、証明書の偽造が可能になる可能性があります。SHA-2ファミリー（例：sha256WithRSAEncryption）に基づく署名を使用して再発行する必要があります。`


#### チェック4：発行者タイプ（自己署名チェック）

- 条件：証明書の`Issuer`と`Subject`フィールドが同一である。

- 重大度：情報提供

- 報告メッセージ：`これは自己署名証明書です。これが意図的であり、信頼が明示的に設定されている開発、テスト、または内部サービスにのみ使用されていることを確認してください。自己署名証明書は、ブラウザや標準クライアントによって信頼されないため、公開されている本番システムには決して使用しないでください。`


### 3. 実行可能な例

フィードバックは直接的で理解しやすいものである必要があります。

例1：期限切れのインライン証明書のフラグ付け

- コードスニペット：

    ```
    # legacy_serviceへの接続用証明書
    LEGACY_CERT = """
    -----BEGIN CERTIFICATE-----
    MIIC...（2024-12-01に期限切れになった証明書のデータ）...
    -----END CERTIFICATE-----
    """
    ```

- 分析と報告：

    > 重大な脆弱性：`LEGACY_CERT`変数に保存されている証明書は無効です。
    >
    > - 理由：2024-12-01に期限切れになりました。
    >
    > - 影響：この証明書を使用しようとするTLS接続は失敗します。
    >
    > - 対策：この証明書を直ちに更新し、変数を新しいPEMデータで更新する必要があります。
    >


例2：読み込まれた証明書の弱い鍵のフラグ付け

- コードスニペット：

    ```
    // ディスクからサーバー証明書をロード
    cert, err := tls.LoadX509KeyPair("server.crt", "server.key")
    // server.crtが1024ビットRSA鍵を含むと仮定。
    ```

- 分析と報告：

    > 高優先度の警告：`server.crt`から読み込まれている証明書は弱い公開鍵を使用しています。
    >
    > - 理由：1024ビットモジュラスのRSA鍵を使用しています。
    >
    > - 影響：この鍵強度は不十分で、現代の暗号解析攻撃に脆弱です。
    >
    > - 対策：少なくとも2048ビットRSA鍵または最新の楕円曲線で新しい証明書と鍵を生成する必要があります。


このルールがどのように適用されたか、なぜ適用されたかを常に説明する必要があります。
