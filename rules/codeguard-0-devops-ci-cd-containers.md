---
description: DevOps、CI/CD、コンテナ（パイプラインハードニング、成果物、Docker/K8sイメージ、仮想パッチ、ツールチェーン）
languages:
- docker
- javascript
- powershell
- shell
- xml
- yaml
alwaysApply: false
---

## DevOps、CI/CD、コンテナ

ビルド、パッケージング、デプロイのサプライチェーンを保護：パイプラインと成果物を保護し、コンテナをハードニングし、必要に応じて仮想パッチとツールチェーンフラグを使用。

### CI/CDパイプラインセキュリティ
- リポジトリ：保護されたブランチ、必須レビュー、署名付きコミット。
- シークレット：ハードコーディングしない。実行時にvault/KMSから取得。ログでマスク。
- 最小権限：最小限の権限を持つエフェメラルで分離されたランナーを使用。
- CIのセキュリティゲート：SAST、SCA、DAST、IaCスキャンを実施。クリティカルな問題でブロック。
- 依存関係：ロックファイルで固定。整合性を検証。プライベートレジストリを使用。
- すべてに署名：コミットと成果物（コンテナ/jar）に署名し、デプロイ前に検証。SLSAプロビナンスを採用。

### Dockerとコンテナのハードニング
- ユーザー：非rootで実行。Dockerfileで`USER`を設定。
- `--security-opt=no-new-privileges`を使用して権限昇格を防止。
- ケーパビリティ：`--cap-drop all`を使用し、必要なものだけを追加。`--privileged`は使用しない。
- デーモンソケット：`/var/run/docker.sock`をマウントしない。
- TLSなしでTCP Dockerデーモンソケット（`-H tcp://0.0.0.0:XXX`）を有効化しない。
- docker-composeファイルで`- "/var/run/docker.sock:/var/run/docker.sock"`を使用しない。
- ファイルシステム：読み取り専用ルート、一時書き込みにはtmpfsを使用。リソース制限（CPU/メモリ）を設定。
- ネットワーク：ホストネットワークを避ける。カスタムネットワークを定義。公開ポートを制限。
- イメージ：最小限のベース（distroless/alpine）、タグとダイジェストを固定。最終イメージからパッケージマネージャーとツールを削除。`HEALTHCHECK`を追加。
- シークレット：Docker/Kubernetesシークレットを使用。レイヤー/環境変数に含めない。ランタイムシークレットでマウント。
- スキャン：ビルド時とアドミッション時にイメージをスキャン。高深刻度の脆弱性をブロック。

### コンテナ内のNode.js
- 決定論的ビルド：`npm ci --omit=dev`を使用。ダイジェスト付きベースイメージを固定。
- 本番環境：`ENV NODE_ENV=production`を設定。
- 非root：正しい所有権でコピーし、`USER node`に切り替え。
- シグナル：init（例：`dumb-init`）を使用し、グレースフルシャットダウンハンドラーを実装。
- マルチステージビルド：ビルドとランタイムを分離。BuildKitでシークレットをマウント。`.dockerignore`を使用。

### 仮想パッチ（一時的な緩和策）
- コード修正がまだ不可能な場合、WAF/IPS/ModSecurityを使用して即座に保護。
- 精度のためにポジティブセキュリティルール（許可リスト）を優先。エクスプロイト固有のシグネチャは避ける。
- プロセス：事前にツールを準備。CVEを分析。最初はログのみでパッチを実装し、その後強制。コード修正後に廃止し追跡。

### C/C++ツールチェーンハードニング（該当する場合）
- コンパイラ：`-Wall -Wextra -Wconversion`、`-fstack-protector-all`、PIE（`-fPIE`/`-pie`）、`_FORTIFY_SOURCE=2`、CFI（LTOで`-fsanitize=cfi`）。
- リンカー：RELRO/now、noexecstack、NX/DEPとASLR。
- デバッグ vs リリース：デバッグでサニタイザーを有効化。リリースでハードニングフラグを有効化。アサートはデバッグのみ。
- CIチェック：フラグを検証（`checksec`）し、保護が欠けている場合はビルドを失敗させる。

### 実装チェックリスト
- パイプライン：シークレットをvaultに保存。エフェメラルランナー。セキュリティスキャン。プロビナンス付き署名済み成果物。
- コンテナ：非root、最小権限、読み取り専用FS、リソース制限。デーモンソケットマウントなし。
- イメージ：最小限、固定、スキャン済み。ヘルスチェック。`.dockerignore`をメンテナンス。
- Nodeイメージ：`npm ci`、`NODE_ENV=production`、適切なinitとシャットダウン。
- 仮想パッチ：定義されたプロセス。正確なルール。ログ。修正後の廃止。
- ネイティブビルド：ハードニングフラグを有効化し、CIで検証。
