---
description: セキュアなファイル処理・アップロード（検証、ストレージ分離、スキャン、安全な配信）
languages:
- c
- go
- java
- javascript
- php
- python
- ruby
- typescript
alwaysApply: false
---

## ファイルアップロードセキュリティガイドライン

このルールは、悪意のあるファイル攻撃を防ぎ、システムの整合性を保護するための安全なファイルアップロード手法を示します。

- 拡張子検証
  - ビジネスクリティカルな機能に対してのみ許可される拡張子をリスト化します。
  - 拡張子を検証する前に入力検証を適用することを確認します。
  - 二重拡張子（例：`.jpg.php`）とヌルバイトインジェクション（例：`.php%00.jpg`）を避けます。
  - ファイル拡張子には拒否リストではなく許可リストアプローチを使用します。
  - バイパス試行を防ぐため、ファイル名をデコードした後に拡張子を検証します。

- コンテンツタイプとファイルシグネチャ検証
  - クライアントが提供するContent-Typeヘッダーは偽装可能なため、決して信頼しません。
  - Content-Typeチェックと併せてファイルシグネチャ（マジックナンバー）を検証します。
  - 迅速な保護レイヤーとしてMIMEタイプの許可リストアプローチを実装します。
  - ファイルシグネチャ検証を使用しますが、単独のセキュリティ対策としては使用しません。

- ファイル名のセキュリティ
  - ユーザー提供の名前を使用する代わりに、ランダムなファイル名（UUID/GUID）を生成します。
  - ユーザーファイル名が必要な場合、最大長制限を実装します。
  - 英数字、ハイフン、スペース、ピリオドのみに文字を制限します。
  - 先頭のピリオド（隠しファイル）と連続したピリオド（ディレクトリトラバーサル）を防止します。
  - より安全なシェルスクリプト処理のため、先頭のハイフンまたはスペースを避けます。

- ファイルコンテンツ検証
  - 画像の場合、悪意のあるコンテンツを破壊するため画像書き換え技術を適用します。
  - Microsoftドキュメントの場合、検証にApache POIを使用します。
  - 多数の攻撃ベクトルがあるため、ZIPファイルを避けます。
  - リソースが許す場合、サンドボックス環境で手動ファイルレビューを実装します。
  - 該当するファイルタイプにはウイルススキャンとContent Disarm & Reconstruct（CDR）を統合します。

- ストレージセキュリティ
  - 可能な場合、完全な分離のため異なるサーバーにファイルを保存します。
  - 管理者アクセスのみで、Webルート外にファイルを保存します。
  - Webルートに保存する場合、適切なアクセス制御で書き込み専用権限を設定します。
  - パブリックアクセス用にIDをファイル名にマッピングするアプリケーションハンドラーを使用します。
  - DBAの専門知識がある特定のユースケースでは、データベースストレージを検討します。

- アクセス制御と認証
  - ファイルアップロードを許可する前にユーザー認証を要求します。
  - ファイルアクセスと変更に対する適切な認可レベルを実装します。
  - 最小権限の原則でファイルシステム権限を設定します。
  - 実行権限が必要な場合は、実行前にファイルをスキャンします。

- アップロード・ダウンロード制限
  - アップロード保護のため適切なファイルサイズ制限を設定します。
  - 圧縮ファイルには展開後のサイズ制限を検討します。
  - DoS攻撃を防ぐため、ダウンロードサービスにリクエスト制限を実装します。
  - ZIPファイルサイズを安全に計算する安全な方法を使用します。

- 追加のセキュリティ対策
  - CSRF攻撃からファイルアップロードエンドポイントを保護します。
  - すべてのファイル処理ライブラリを安全に設定し、最新に保ちます。
  - アップロード活動のロギングと監視を実装します。
  - 違法コンテンツに対するユーザー報告メカニズムを提供します。
  - 圧縮ファイルには安全な展開方法を使用します。

まとめ：
多層検証、セキュアなストレージ手法、適切なアクセス制御、包括的な監視を通じて、ファイルアップロードに対する多層防御を実装します。単一の検証方法に依存せず、攻撃を防ぐため常に安全なファイル名を生成します。
