---
description: API・Webサービスのセキュリティ（REST/GraphQL/SOAP）、スキーマ検証、認証/認可、SSRF対策
languages:
- c
- go
- java
- javascript
- php
- python
- ruby
- typescript
- xml
- yaml
alwaysApply: false
---

## API・Webサービスのセキュリティ

REST、GraphQL、SOAP/WSサービスをエンドツーエンドで保護：トランスポート、認証/認可、スキーマ検証、SSRF制御、DoS制限、マイクロサービス安全パターン。

### トランスポートとTLS
- HTTPSのみ使用；高価値/内部サービスにはmTLSを検討。証明書（CN/SAN、失効）を検証し、混在コンテンツを防止。

### 認証とトークン
- クライアントには標準フロー（OAuth2/OIDC）を使用；独自スキームは避ける。サービスにはmTLSまたは署名付きサービストークンを使用。
- JWT：アルゴリズムを固定；iss/aud/exp/nbfを検証；短いライフタイム；ローテーション；ログアウト/失効時は拒否リストへ。失効が必要で中央ストアが利用可能な場合は、不透明トークンを優先。
- APIキー：スコープを狭く限定；レート制限；使用状況を監視；機密操作には単独で使用しない。

### 認可
- エンドポイントごと、リソースごとのチェックをサーバー側で強制；デフォルトで拒否。
- マイクロサービスの場合、ゲートウェイ（粗粒度）とサービス（細粒度）レイヤーで認可；外部トークンではなく署名付き内部IDを伝播。

### 入力とコンテンツ処理
- コントラクトで入力を検証：OpenAPI/JSON Schema、GraphQL SDL、XSD。不明なフィールドと過大なペイロードを拒否；制限を設定。
- Content Type：明示的なContent-Type/Acceptを強制；サポートされていない組み合わせを拒否。XMLパーサーをXXE/展開攻撃から保護。

### リゾルバとハンドラでのSQL/インジェクション安全性
- パラメータ化クエリ/ORM bindパラメータを使用；ユーザー入力をクエリやコマンドに連結しない。

### GraphQL固有の制御
- クエリの深さと全体的な複雑さを制限；ページネーションを強制；実行時のタイムアウト；本番環境ではイントロスペクションとIDEを無効化。
- フィールド/オブジェクトレベルの認可を実装してIDOR/BOLAを防止；バッチ処理を検証し、オブジェクトタイプごとにレート制限。

### 外部呼び出しのSSRF防止
- 生のURLを受け入れない。ライブラリを使用してドメイン/IPを検証；HTTP/HTTPSのみに制限（file://、gopher://、ftp://等をブロック）。
- ケース1（固定パートナー）：厳格な許可リスト；リダイレクトを無効化；ネットワーク出力許可リスト。
- ケース2（任意）：プライベート/リンクローカル/localhostレンジをブロック；すべてのIPを解決してパブリックであることを確認；可能であればターゲットからの署名付きトークンを要求。

### SOAP/WSとXMLの安全性
- XSDでSOAPペイロードを検証；メッセージサイズを制限；必要に応じてXML署名/暗号化を有効化。
- XXE、エンティティ展開、再帰的ペイロードに対してパーサーを設定；添付ファイルをスキャン。

### レート制限とDoS
- IP/ユーザー/クライアントごとの制限、サーキットブレーカー、タイムアウトを適用。サーバー側のバッチ処理とキャッシングで負荷を軽減。

### 管理エンドポイント
- インターネット上に公開しない。強力な認証（MFA）、ネットワーク制限、別ポート/ホストを要求。

### テストと評価
- 正式なAPI定義を維持；仕様からコントラクトテストとファジングを実施。
- 認証/認可バイパス、SSRF、インジェクション、情報漏洩についてエンドポイントを評価；トークン検証失敗をログに記録。

### マイクロサービスのプラクティス
- 組み込み決定ポイントを持つPolicy-as-code；サイドカーまたはライブラリPDP。
- mTLSまたは署名付きトークンによるサービスID；外部トークンを内部で再利用しない。
- 相関IDを使用した中央集中型構造化ログ；機密データをサニタイズ。

### 実装チェックリスト
- HTTPS/mTLSを設定；証明書を管理；混在コンテンツなし。
- エッジとサービスでコントラクト検証；不明なフィールドを拒否；サイズ/時間制限を強制。
- エンドポイントごとに強力な認証/認可；GraphQL制限を適用；本番環境ではイントロスペクション無効化。
- アプリとネットワークレイヤーでSSRF保護；リダイレクトを無効化；可能な場合は許可リスト。
- レート制限、サーキットブレーカー、復元力のあるパターンを導入。
- 管理エンドポイントを分離し、強力に認証。
- 相関IDを持つ構造化されたプライバシー安全なログ。

### テストプラン
- スキーマ準拠のコントラクトテスト；スキーマ対応ツールでのファジング。
- SSRF、IDOR/BOLA、認可バイパスのペネトレーションテスト；DoS制限のパフォーマンステスト。
- エンドポイントごとにすべてのHTTPメソッドをテスト；明白なクエリ文字列以外のURLパス、ヘッダー、構造化データのパラメータを発見。
- トークン検証と失効動作の自動チェック。
