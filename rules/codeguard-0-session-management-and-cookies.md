---
description: セッション管理とセキュアクッキー（ローテーション、固定化、タイムアウト、盗難検出）
languages:
- c
- go
- html
- java
- javascript
- php
- python
- ruby
- typescript
alwaysApply: false
---

## セッション管理とクッキー

固定化、ハイジャック、盗難を防ぎながら使いやすさを維持する、堅牢で攻撃に強いセッション処理を実装。

### セッションID生成とプロパティ
- CSPRNGでセッションIDを生成。64ビット以上のエントロピー（128以上を推奨）。不透明で推測不可能、意味を持たない。
- フレームワークのデフォルトではなく、汎用的なクッキー名（例：`id`）を使用。サーバーで作成されていない受信IDを拒否。
- すべてのセッションデータをサーバー側に保存。PIIや権限をトークンに埋め込まない。機密性が高い場合、サーバー側セッションストアを保存時に暗号化。

### クッキーセキュリティ設定
- セッションクッキーに`Secure`、`HttpOnly`、`SameSite=Strict`（フローに必要な場合は`Lax`）を設定。
- `Path`と`Domain`でクッキーのスコープを狭く設定。サブドメイン間の露出を避ける。
- 非永続セッションクッキーを優先（Expires/Max-Ageなし）。完全なHTTPSを要求。サイト全体でHSTSを有効化。

ヘッダーの例：
```
Set-Cookie: id=<opaque>; Secure; HttpOnly; SameSite=Strict; Path=/
```

### セッションライフサイクルとローテーション
- セッションはサーバー側のみで作成。提供されたIDは信頼できない入力として扱う。
- 認証、パスワード変更、権限昇格時にセッションIDを再生成。以前のIDを無効化。
- フレームワークパターンで必要な場合、認証前と認証後で異なるクッキー名を使用。

### 有効期限とログアウト
- アイドルタイムアウト：高価値の場合2〜5分、低リスクの場合15〜30分。絶対タイムアウト：4〜8時間。
- タイムアウトをサーバー側で強制。サーバーセッションを完全に無効化し、クライアント側でクッキーをクリアする、視認可能なログアウトボタンを提供。

### トランスポートとキャッシング
- セッション全体のジャーニーでHTTPSを強制。1つのセッション内でHTTP/HTTPSを混在させない。
- セッション識別子または機密データを含むレスポンスに`Cache-Control: no-store`を送信。

### クッキー盗難検出と対応
- 確立時にサーバー側でセッションコンテキストをフィンガープリント（IP、User-Agent、Accept-Language、利用可能な場合は関連する`sec-ch-ua`）。
- 受信リクエストを保存されたフィンガープリントと比較し、良性のずれ（例：サブネット変更、UA更新）を許容。
- リスクベースの対応：
  - 高リスク：再認証を要求。セッションIDをローテーション。
  - 中リスク：段階的検証（チャレンジ）。セッションIDをローテーション。
  - 低リスク：疑わしいアクティビティをログ記録。
- 潜在的なハイジャックが検出された場合、常にセッションIDを再生成。

### クライアント側ストレージ
- XSSリスクのため、セッショントークンを`localStorage`/`sessionStorage`に保存しない。トランスポートにはHttpOnlyクッキーを優先。
- 非セッションシークレットのクライアント側ストレージが避けられない場合、Web Workerで分離し、ページコンテキストに決して公開しない。

### フレームワークと複数クッキーのシナリオ
- 組み込みセッションフレームワークを優先。最新に保ち、ハードニング。
- 複数のクッキーがセッション状態に参加する場合、関係性を検証。パス/ドメイン間で同じクッキー名を避ける。

### 監視とテレメトリ
- セッションID の生の値ではなく、ソルト付きハッシュを使用してセッションライフサイクルイベント（作成、ローテーション、終了）をログ記録。
- セッションIDのブルートフォースと異常な同時使用を監視。

### 実装チェックリスト
1) CSPRNGセッションID（64ビット以上のエントロピー）、不透明でサーバー発行のみ。
2) クッキーフラグ：`Secure`、`HttpOnly`、`SameSite`を設定。厳格なdomain/path。
3) HSTSを伴うHTTPSのみ。混在コンテンツなし。
4) 認証と権限変更時にIDを再生成。古いIDを無効化。
5) アイドルと絶対タイムアウトをサーバー側で強制。完全なログアウトを実装。
6) 機密レスポンスに`Cache-Control: no-store`を設定。
7) サーバー側フィンガープリントと異常へのリスクベース対応。
8) セッショントークンのクライアントストレージなし。フレームワークデフォルトをハードニング。
