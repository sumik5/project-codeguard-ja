---
description: ブラウザ拡張機能セキュリティベストプラクティス
languages:
- c
- javascript
- typescript
alwaysApply: false
---

ブラウザ拡張機能は機密性の高いユーザーデータにアクセスでき、Webページコンテンツを変更できるため、セキュリティが最優先事項です。拡張機能を開発する際に焦点を当てるべき主要な領域を以下に示します。

### 1. マニフェスト：セキュリティの基盤

`manifest.json`ファイルは拡張機能のセキュリティモデルの中核です。最小権限の原則で設定してください。

*   **権限:** 拡張機能が機能するために絶対に必要な権限のみを要求。`<all_urls>`や`http://*/*`などの広範なホスト権限を避ける。いくつかのサイトにのみアクセスする必要がある場合は、明示的に指定。
*   **コンテンツセキュリティポリシー（CSP）:** XSSや他のインジェクション攻撃を軽減するために厳格なCSPを定義。良い出発点：

    ```json
    "content_security_policy": {
      "extension_pages": "script-src 'self'; object-src 'self'"
    }
    ```

    このポリシーはインラインスクリプトと`eval()`を禁止し、スクリプトとオブジェクトのソースを拡張機能自身のパッケージに制限。

### 2. 安全なコーディングプラクティス

*   **動的コード実行を避ける:** `eval()`、`new Function()`、文字列を伴う`setTimeout()`、リモートURLの動的`import()`を決して使用しない。これらは重大なセキュリティリスク。

*   **DOM入力をサニタイズ:** コンテンツスクリプトからのXSSを防ぐために、完全にサニタイズされていないデータで`.innerHTML`を決して使用しない。`.textContent`などのより安全なAPIを優先するか、DOMPurifyなどの信頼されたライブラリを使用。

    **例:**
    ```javascript
    // 安全でない:
    document.getElementById('user-greeting').innerHTML = `Welcome, ${userInput}!`;

    // 安全:
    document.getElementById('user-greeting').textContent = `Welcome, ${userInput}!`;
    ```

### 3. データストレージと通信

*   **`chrome.storage`を使用:** 機密情報を保存するために`localStorage`を避ける。`localStorage`は同じオリジン上のすべてのスクリプトからアクセス可能で、ページに注入された潜在的に悪意のあるスクリプトも含まれます。代わりに拡張機能に隔離された`chrome.storage` APIを使用。
*   **機密データを暗号化:** 機密ユーザーデータを保存する前に暗号化。
*   **HTTPSを使用:** すべてのネットワーク通信はHTTPS（WebSocketsには`wss://`）を使用して転送中のデータを保護。ネットワークリクエストをモニタリングして不正なデータ流出を防止。

### 4. Webページとの相互作用

*   **機密UIを隔離:** 機密情報をWebページのDOMに直接注入しない。ページ上の悪意のあるスクリプトがこのデータをスクレイピングできます。代わりに、ポップアップ、サイドバー、オプションページなどの拡張機能所有のUI要素に機密情報を表示。
*   **メッセージパッシングを使用:** コンテンツスクリプトとバックグラウンドスクリプト間の通信に標準のメッセージパッシングAPI（`chrome.runtime.sendMessage`、`chrome.tabs.sendMessage`）を使用。通信チャネルとしてDOMを使用しない。

### 5. サプライチェーンセキュリティ

*   **依存関係を監査:** `npm audit`などのツールを使用してサードパーティライブラリを定期的に監査。悪意のあるまたは脆弱な依存関係は拡張機能全体を侵害する可能性があります。
*   **リモートコードなし:** リモートコードを取得して実行しない。拡張機能のすべてのロジックは初期パッケージに含まれるべきです。これはほとんどのブラウザ拡張マーケットプレイスの要件です。
