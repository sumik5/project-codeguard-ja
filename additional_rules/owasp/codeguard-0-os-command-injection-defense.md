---
description: OSコマンドインジェクション防御
languages:
- c
- go
- java
- javascript
- perl
- php
- python
- ruby
- shell
alwaysApply: false
---

## OSコマンドインジェクション防御ガイドライン

アプリケーションでシステムコマンドを実行する際のOSコマンドインジェクション脆弱性を防ぐための必須プラクティス。

### コマンドインジェクションの理解

コマンドインジェクションは、ソフトウェアが外部から影響を受ける入力を使用してシステムコマンドを構築する際に、意図したコマンドを変更できる特殊要素を適切に無害化しない場合に発生します。

脆弱な入力の例:
```
calc & echo "test"
```

これは`calc`だけを実行する意味から、`calc`と`echo "test"`の両方を実行する意味に変更されます。

#### 引数インジェクション

すべてのOSコマンドインジェクションは引数インジェクションでもあり、特定のコマンドを実行する際にユーザー入力が引数として渡される可能性があります。例:

```php
system("curl " . escape("--help"))
```

エスケープ処理があっても、これは意図した動作ではなく`curl --help`の出力を表示します。

### 主要な防御策

#### 防御オプション1: OSコマンドの直接呼び出しを避ける

主要な防御策は、OSコマンドを直接呼び出すことを避けることです。組み込みライブラリ関数は、意図しないタスクを実行するように操作できないため推奨されます。

例: `system("mkdir /dir_name")`の代わりに`mkdir()`を使用します。

#### 防御オプション2: OSコマンドに追加される値をエスケープする

OSコマンドを避けられない場合は、言語固有のエスケープ関数を使用します。

PHPでescapeshellarg()を使用する例:
`escapeshellarg()`関数はユーザー入力をシングルクォートで囲むため、`& echo "hello"`のような不正な入力は`calc '& echo "hello"'`となり、単一の引数として解析されます。

注意: `escapeshellarg()`を使用しても、攻撃者はコマンドに単一の引数を渡すことができます。

#### 防御オプション3: 入力検証によるパラメータ化

ユーザー入力を組み込んだシステムコマンドを避けられない場合は、2つの防御層を使用します:

第1層 - パラメータ化:
データとコマンド間の分離を自動的に強制し、適切な引用符とエンコーディングを提供する構造化されたメカニズムを使用します。

第2層 - 入力検証:
- コマンド: 許可されたコマンドのリストに対して検証
- 引数: 引数が明示的に定義される許可リスト/ホワイトリスト入力検証を使用
- 許可リスト正規表現: 許可される文字と最大長を定義し、メタ文字を除外

小文字の英字と数字のみを許可する例（3〜10文字）: `^[a-z0-9]{3,10}$`

POSIXガイドライン: 引数インジェクションを防ぐために`--`デリミタを使用:
```
curl -- $url
```
これにより、`$url`に追加の引数が含まれていても引数インジェクションを防ぎます。

避けるべき危険なメタ文字:
```
& |  ; $ > < ` \ ! ' " ( )
```

### コード例

#### Java

コマンドと引数を分離してProcessBuilderを使用:

不適切な使用:
```java
ProcessBuilder b = new ProcessBuilder("C:\DoStuff.exe -arg1 -arg2");
```

正しい使用:
```java
ProcessBuilder pb = new ProcessBuilder("TrustedCmd", "TrustedArg1", "TrustedArg2");

Map<String, String> env = pb.environment();

pb.directory(new File("TrustedDir"));

Process p = pb.start();
```

Runtime.execに関する注意:
Javaの`Runtime.exec`はシェルを呼び出さず、シェルメタ文字をサポートしません。文字列を配列に分割し、最初の単語を残りをパラメータとして実行するため、シェルベースの攻撃は効果がありません。


#### PHP

exec()、system()、passthru()ではなく、escapeshellarg()またはescapeshellcmd()を使用します。

### 追加の防御策

多層防御を実装:
- アプリケーションは必要なタスクに必要な最小限の権限で実行すべき
- 単一のタスク用に限定された権限を持つ隔離されたアカウントを作成

### 実装まとめ

安全なコマンド実行には以下が必要:
- 可能な場合はOSコマンドを避ける（組み込みライブラリを使用）
- コマンドと引数を分離したパラメータ化された実行を使用
- 許可リストによる厳格な入力検証を実装
- 利用可能な場合は適切なエスケープ関数を適用
- 最小限の権限でアプリケーションを実行
- データ/コマンド分離を強制する構造化されたメカニズムを使用

これらのプラクティスに従うことで、アプリケーションのOSコマンドインジェクション脆弱性のリスクを大幅に削減できます。
