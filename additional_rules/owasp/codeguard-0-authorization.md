---
description: 認可セキュリティのベストプラクティス
languages:
- c
- go
- java
- javascript
- php
- python
- ruby
- typescript
- yaml
alwaysApply: false
---

堅牢な認可を実装することは、ユーザーが許可されたデータと機能のみにアクセスできることを保証するために不可欠です。認証はユーザーが誰であるかを確認しますが、認可はユーザーが何をできるかを決定します。

### 安全な認可の基本原則

1.  **デフォルトで拒否：** 任意のアクセスリクエストのデフォルトは「拒否」とします。明示的に拒否するのではなく、ロールまたはユーザーに権限を明示的に付与します。許可ルールが一致しない場合、HTTP 403 Forbiddenを返します。
2.  **最小権限の原則：** ユーザーには職務を遂行するために必要な最小限のアクセスレベルを付与します。権限が過剰でないことを確認するため、定期的に監査します。
3.  **すべてのリクエストで権限を検証：** ソースに関係なく（AJAX、API、直接）、すべてのリクエストで認可をチェックします。ミドルウェア/フィルターを使用して一貫した強制を確保します。
4.  **RBACよりABAC/ReBACを優先：** シンプルなロールベースアクセス制御の代わりに、属性ベースアクセス制御（ABAC）または関係ベースアクセス制御（ReBAC）を使用して詳細な権限を実現します。

### サーバーサイド強制は交渉の余地なし

すべての認可決定は、すべてのリクエストに対してサーバーサイドで強制される必要があります。クライアントサイドチェックはユーザーエクスペリエンスのみを目的としており、容易にバイパスされます。

**避けるべきこと（アンチパターン）：**

```javascript
// 安全でない：攻撃者がバイパスできるクライアントサイドチェック。
if (currentUser.isAdmin) {
  showAdminDashboard();
} // データを返す前に、サーバーもユーザーが管理者であるかをチェックする必要があります。
```

**ベストプラクティス：**

バックエンドフレームワークで集中化されたミドルウェアまたはデコレーターを使用して、すべての関連エンドポイント全体で認可チェックを一貫して強制します。

**例（デフォルト拒否を示すExpress.jsミドルウェア）：**

```javascript
function canViewProject(req, res, next) {
  const project = await db.getProject(req.params.id);

  // 明示的な許可条件
  if (project.ownerId === req.user.id) {
    return next(); // 所有者は表示可能
  }
  if (req.user.isAdmin) {
    return next(); // 管理者は表示可能
  }
  if (project.isPublic && req.user.isVerified) {
    return next(); // 検証済みユーザーは公開プロジェクトを表示可能
  }

  // デフォルトで拒否 - 許可ルールが一致しない
  return res.status(403).json({
    error: 'Access denied',
    message: 'You do not have permission to view this resource'
  });
}

app.get('/projects/:id', isAuthenticated, canViewProject, (req, res) => {
  // プロジェクトデータを返す
});
```

### 安全でない直接オブジェクト参照（IDOR）の防止

IDOR脆弱性は、アプリケーションがユーザー提供の識別子（データベースIDなど）を使用してオブジェクトに直接アクセスする際に、ユーザーが*その特定のオブジェクト*にアクセスする権限を持っているか検証しない場合に発生します。

**避けるべきこと（アンチパターン）：**

```javascript
// 安全でない：コードはユーザーが認証されているかをチェックしますが、
// 指定されたIDの請求書を表示する権限があるかをチェックしません。
app.get('/invoices/:id', isAuthenticated, (req, res) => {
  const invoice = await db.getInvoice(req.params.id); // 攻撃者はIDを巡回可能
  res.json(invoice);
});
```

**ベストプラクティス：**

認証されたユーザーが要求している特定のオブジェクトに対して必要な権限を持っていることを常に検証します。

### 追加のベストプラクティス

*   **トークンライフサイクル管理：** ログアウト/ロール変更時のトークン取り消しと、権限変更時のセッション無効化を実装します。
*   **集中化されたエラー処理：** 認可失敗時には情報漏洩を避けるため、汎用的なエラーメッセージ（403 Forbiddenまたは404 Not Found）を返します。
*   **包括的なログ：** セキュリティ監視のため、ユーザーID、リソース、アクション、タイムスタンプを含むすべての認可失敗をログに記録します。
*   **テスト：** 認可ロジックの単体テストと統合テストを記述します。肯定的（アクセス可能であるべき）および否定的（拒否されるべき）の両方のケースをテストします。
*   **静的リソース：** APIエンドポイントだけでなく、静的ファイル、クラウドストレージ、その他のリソースにも認可チェックを適用します。
