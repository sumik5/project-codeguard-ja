---
description: 入力検証セキュリティのベストプラクティス
languages:
- c
- go
- java
- javascript
- php
- python
- ruby
- sql
- typescript
- xml
alwaysApply: false
---

## 入力検証セキュリティガイドライン

このルールは、アプリケーションで堅牢な入力検証セキュリティ機能を実装するための明確で実行可能なガイダンスを提供します。

### はじめに

入力検証は、適切に形成されたデータのみがワークフローに入ることを保証し、不正な形式のデータがデータベースに永続化され、下流コンポーネントの誤動作を引き起こすことを防ぎます。入力検証はデータフローの可能な限り早い段階で行うべきです。

潜在的に信頼できないソースからのすべてのデータは入力検証の対象とすべきです。これには、インターネットに面したWebクライアントやサプライヤー、パートナー、ベンダー、規制当局からのバックエンドフィードが含まれます。

入力検証は、XSS、SQLインジェクション、その他の攻撃を防ぐ主要な方法として使用すべきではありませんが、適切に実装されれば、それらの影響を大幅に軽減することができます。

### 入力検証戦略

- 構文検証：構造化フィールドの正しい構文を強制（例：SSN、日付、通貨記号）
- 意味検証：特定のビジネスコンテキストにおける値の正確性を強制（例：開始日が終了日より前、価格が期待範囲内）

### 入力検証の実装

- Webアプリケーションフレームワークで利用可能なデータ型バリデータ（Django Validators、Apache Commons Validators）
- JSON SchemaおよびXML Schema（XSD）との照合検証
- 厳格な例外処理を伴う型変換（JavaのInteger.parseInt()、Pythonのint()）
- 数値パラメータの範囲チェックと文字列の長さチェック
- 小さな文字列パラメータセットの許可値配列
- 入力文字列全体をカバーする正規表現（^...$）、「任意の文字」ワイルドカードを避ける

### 許可リスト vs 拒否リスト

許可リスト検証は、何が認可されているかを正確に定義します。それ以外はすべて認可されていません。構造化データ（日付、SSN、郵便番号、メール）には、正規表現を使用して強力な検証パターンを定義します。固定オプション（ドロップダウン、ラジオボタン）の場合、入力は提供される値の1つと正確に一致する必要があります。

### 自由形式Unicodeテキストの検証

- 正規化：すべてのテキストで正規エンコーディングを保証
- 文字カテゴリ許可リスト：「10進数字」や「文字」などのUnicodeカテゴリを使用
- 個別文字許可リスト：名前のアポストロフィなど特定の文字を許可

### 正規表現（Regex）

RegEx Denial of Service（ReDoS）攻撃に注意してください。入力検証は：
- すべての入力データに適用されるべき
- 許可文字セットを定義
- 最小および最大長を定義（例：{1,25}）

### 許可リスト正規表現の例

米国郵便番号：`^\d{5}(-\d{4})?$`

Javaの例：
```java
private static final Pattern zipPattern = Pattern.compile("^\d{5}(-\d{4})?$");

public void doPost(HttpServletRequest request, HttpServletResponse response) {
  try {
      String zipCode = request.getParameter("zip");
      if (!zipPattern.matcher(zipCode).matches()) {
          throw new YourValidationException("不適切な郵便番号形式。");
      }
  } catch(YourValidationException e) {
      response.sendError(response.SC_BAD_REQUEST, e.getMessage());
  }
}
```

### クライアントサイド vs サーバーサイド検証

入力検証は、データ処理の前にサーバーサイドで実装する必要があります。クライアントサイド検証は攻撃者によって回避される可能性があります。

### ファイルアップロード検証

アップロード検証：
- ファイル名が期待される拡張子タイプを使用していることを検証
- 最大ファイルサイズ制限を強制
- 展開前にZIPファイルをチェック（ターゲットパス、圧縮レベル、推定サイズ）

アップロードストレージ：
- サーバー生成のランダムファイル名を使用
- 悪意のあるコンテンツについてアップロードされたファイルを分析
- サーバーがファイルパスを定義、クライアントではない

危険なファイルタイプに注意：
- crossdomain.xml / clientaccesspolicy.xml
- .htaccessと.htpasswd
- Web実行可能スクリプト：aspx、asp、css、swf、jsp、js、php、cgi

画像アップロード：
- 画像書き換えライブラリを使用してコンテンツを検証および除去
- 検出されたコンテンツタイプに基づいて拡張子を設定
- コンテンツタイプが定義された画像タイプ内にあることを確認

### メールアドレス検証

構文検証：
- @で区切られた2つの部分を含む
- 危険な文字なし（バッククォート、引用符、nullバイト）
- ドメインには文字、数字、ハイフン、ピリオドのみ
- 長さ制限：ローカル部分≤63文字、合計≤254文字

意味検証：
- 安全なトークン付き検証メールを送信
- トークン要件：≥32文字、暗号学的にランダム、単一使用、時間制限付き
