---
description: パスワード忘れセキュリティのベストプラクティス
languages:
- c
- go
- java
- javascript
- php
- python
- ruby
- typescript
alwaysApply: false
---

## パスワード忘れセキュリティガイドライン

このルールは、ユーザー列挙、トークン悪用、不正アクセスを防ぐための安全なパスワードリセット実装についてアドバイスします：

- パスワードリセットリクエストセキュリティ
  - ユーザー列挙を防ぐため、存在するアカウントと存在しないアカウントの両方に対して一貫したメッセージを返します。
  - 非同期処理または同一のコードパスを使用して、一貫したレスポンス時間を確保します。
  - フラッディング攻撃を防ぐため、アカウントとIPアドレスごとにレート制限を実装します。
  - リセットリクエストフォームに入力検証とSQLインジェクション防止を適用します。
  - パスワードリセットフォームとエンドポイントを保護するためCSRFトークンを使用します。

- トークン生成と保存
  - 暗号学的に安全な乱数生成器を使用してトークンを生成します。
  - ブルートフォース攻撃を防ぐため、トークンを十分に長くします（最小32バイト）。
  - パスワードリセットトークンをハッシュ化を使用して安全に保存します（パスワード保存と同じ手法）。
  - トークンを有効期限とともにデータベース内の個々のユーザーにリンクします。
  - トークンを単一使用とし、使用成功後に直ちに無効化します。

- パスワードリセットプロセスセキュリティ
  - ユーザーに新しいパスワードを2回入力して確認することを要求します。
  - アプリケーション全体で一貫したパスワードポリシーを強制します。
  - 安全なパスワード保存手法に従って新しいパスワードを保存します。
  - 実際のパスワードを含めずに確認メールを送信します。
  - パスワードリセット後にユーザーを自動的にログインさせないでください。
  - パスワードリセット成功後、すべての既存ユーザーセッションを無効化します。

- URLトークン実装
  - 安全なトークンを生成し、メール配信のためURLクエリ文字列に添付します。
  - リセットURLにはハードコードまたは検証済みの信頼できるドメインを使用します（Hostヘッダーインジェクションを避ける）。
  - すべてのパスワードリセットURLにHTTPSを強制します。
  - リファラー漏洩を防ぐため、'noreferrer'値を持つリファラーポリシーを追加します。
  - トークンブルートフォース試行を防ぐためレート制限を実装します。

- PIN実装
  - 暗号学的に安全な方法を使用して6-12桁のPINを生成します。
  - PINからパスワードリセット操作のみを許可する制限付きセッションを作成します。
  - ユーザーの読みやすさを向上させるため、PINにスペースを含めてフォーマットします。
  - トークンと同じセキュリティ手法を適用します（単一使用、有効期限、安全な保存）。

- セキュリティ質問の統合
  - セキュリティ質問は唯一のメカニズムとしてではなく、追加の層としてのみ使用します。
  - OWASPガイダンスからの安全な質問選択手法に従います。
  - 安全な比較メソッドを使用してセキュリティ質問の回答を検証します。

- ログと監視（コードレベル）
  - ユーザーコンテキストでパスワードリセット試行をログに記録しますが、トークンやパスワードはログに記録しません。
  - セキュリティ監視統合のため構造化ログを実装します。
  - セキュリティ分析のために十分なコンテキスト（IP、ユーザーエージェント、タイムスタンプ）を含めます。
  - アプリケーションログに機密情報を決してログに記録しません。

- アカウントロックアウト防止
  - パスワードリセットリクエストに応答してアカウントをロックしないでください。
  - レート制限と監視を通じて代替の悪用防止を実装します。
  - パスワードリセット悪用保護を認証ロックアウトメカニズムから分離します。

要約：
一貫したレスポンス処理、暗号学的に安全なトークン生成と保存、CSRF保護、適切なセッション管理、包括的なログを通じて安全なパスワードリセット機能を実装し、ユーザー列挙とアカウントロックアウト攻撃を防ぎます。
