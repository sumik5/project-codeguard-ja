---
description: セッション管理セキュリティ
languages:
- c
- go
- java
- javascript
- kotlin
- php
- python
- ruby
- scala
- swift
- typescript
alwaysApply: false
---

## セッション管理セキュリティ

適切なID生成、Cookieセキュリティ、ライフサイクル管理を通じて、セッションハイジャック、固定化、不正アクセスを防ぐための安全なセッション処理を実装します。

### セッションIDのプロパティ

#### 安全な生成
- セッションIDには暗号学的に安全な疑似乱数生成器（CSPRNG）を使用
- 最小64ビットのエントロピーを確保（最低16進数16文字）
- 意味のあるコンテンツを含まない、完全にランダムで不透明なセッションIDを生成
- デフォルトのセッションID名（PHPSESSID、JSESSIONID）を「id」のような汎用名に変更

#### セッションIDの内容
- セッションIDはクライアント側で意味のない識別子である必要があります
- セッションID値に機密情報やPIIを決して含めない
- すべてのセッションデータ（ユーザー詳細、権限、状態）をサーバー側のみに保存
- 機密情報を含む場合、セッションストレージを暗号化

### Cookieセキュリティ設定

#### 必須Cookie属性
- Secure：HTTPS接続経由でのみ送信
- HttpOnly：XSSから保護するためJavaScriptアクセスを防止
- SameSite：CSRF攻撃を緩和するためStrictまたはLaxを使用
- Domain/Path：公開を最小限にするためCookieを狭くスコープ

#### Cookieの永続性
- 非永続的なセッションCookieを使用（ExpiresまたはMax-Age属性なし）
- セッションはブラウザインスタンスが閉じると消える必要があります
- セッション管理に永続的なCookieを避ける

安全なCookie設定の例：
```
Set-Cookie: id=<session-id>; Secure; HttpOnly; SameSite=Strict; Path=/app
```

### トランスポート層セキュリティ

- Webセッション全体にHTTPSを強制し、認証だけでなく全体に適用
- 同じユーザーセッション内でHTTPとHTTPSを決して混在させない
- HTTP Strict Transport Security（HSTS）を実装
- HTTPSリダイレクトが発生した後にのみCookieを設定または再生成

### セッションライフサイクル管理

#### セッションIDの生成と検証
- 厳格なセッション管理を使用 - サーバーが生成したセッションIDのみを受け入れる
- アプリケーションによって以前に作成されていないセッションIDを拒否
- セッションIDを検証が必要な信頼できないユーザー入力として扱う
- 不明なセッションIDを疑わしいアクティビティとして検出しアラート

#### セッションIDの再生成
- 権限レベルの変更後にセッションIDを再生成
- 認証プロセス中の再生成が必須
- パスワード変更、権限変更、役割変更時に再生成
- 認証前/後の状態に異なるセッションID名を使用
- 新しいIDを生成する際、以前のセッションIDを無効化

フレームワークでの再生成の例：
- J2EE：`request.getSession(true)` & `HttpSession.invalidate()`
- ASP.NET：`Session.Abandon()` & `Response.Cookies.Add(new...)`
- PHP：`session_start()` & `session_regenerate_id(true)`

### セッションの有効期限

#### 自動有効期限
- アイドルタイムアウトを実装（高価値は2-5分、低リスクは15-30分）
- 絶対タイムアウトを実装（アプリケーション使用に基づき4-8時間）
- サーバー側でタイムアウトを強制し、クライアント側の制御のみに決して依存しない
- オプションで更新タイムアウトを実装し、定期的にセッションIDを再生成

#### 手動有効期限
- すべてのページに可視的でアクセス可能なログアウトボタンを提供
- ログアウト時にサーバー側でセッションを完全に無効化
- 空の値と過去の有効期限でクライアント側のセッションCookieをクリア

サーバー側無効化の例：
- J2EE：`HttpSession.invalidate()`
- ASP.NET：`Session.Abandon()`
- PHP：`session_destroy()/unset()`

### Webコンテンツキャッシング保護

- セッションIDを含むレスポンスにCache-Control: no-storeを使用
- すべての機密コンテンツに制限的なキャッシュディレクティブを適用
- ブラウザ履歴またはプロキシサーバーでのセッションIDキャッシングを防止
- 機密データを表示するすべてのページにキャッシュ制御ヘッダーを含める

### 攻撃検出と監視

#### セッション攻撃検出
- 単一IPアドレスからのセッションIDブルートフォース試行を監視
- セッションIDの異常と操作試行を検出
- セッションライフサイクルイベント（作成、更新、破棄）をログに記録
- 異常検出のためセッションをクライアントプロパティ（IP、User-Agent）にバインド

#### ログのベストプラクティス
- セッションIDの実際のIDではなく、ソルト付きハッシュを使用してセッションイベントをログに記録
- タイムスタンプ、IPアドレス、User-Agent、操作の詳細を含める
- 同時セッションを監視し、ビジネスポリシーを強制
- 管理セッション管理インターフェースを保護

### クライアント側ストレージセキュリティ

#### 安全でないストレージを避ける
- セッショントークンをlocalStorageまたはsessionStorageに決して保存しない
- XSSリスクのためJavaScriptがアクセス可能なセッションストレージを避ける
- JavaScriptアクセスが必要な場合、シークレットを分離するためWeb Workersを使用
- セッショントークン交換にはHttpOnly Cookieを優先

#### Web Workersの代替
- 永続性が不要な場合、ブラウザストレージにWeb Workersを使用
- シークレットをWeb Workerコンテキスト内に保持し、メインウィンドウに決して送信しない
- HttpOnly Cookieと同様のセキュリティ保証を提供

### フレームワークと実装

#### 組み込みセッション管理
- カスタムソリューションよりも確立されたフレームワークのセッションメカニズムを優先
- フレームワークをセキュリティ修正を含む最新バージョンに保つ
- デフォルトのフレームワーク設定を確認し強化
- 安全なセッションストレージリポジトリ保護を確保

#### 複数Cookie の考慮事項
- 複数のCookieを使用するセッションのすべてのCookieを検証
- 認証前/後のCookie間の関係を強制
- 異なるパスまたはドメインに同じCookie名を避ける
- サブドメイン間のCookie公開を防止

### 再認証要件

高リスクイベントに再認証を要求：
- パスワード変更
- 新しい/疑わしいIPアドレスまたはデバイスからのログイン
- アカウント復旧完了
- 権限昇格イベント

### 追加のセキュリティ対策

#### クライアント側の防御（多層防御）
- セッションID更新を強制するログインタイムアウトを実装
- ブラウザウィンドウクローズイベントで強制ログアウト
- 実行可能な場合、タブ間セッション共有を無効化
- カウントダウン警告付きの自動クライアントログアウト

#### WAF保護
- WebアプリケーションファイアウォールでCookieセキュリティ属性を強制
- WAFベースのセッション固定化保護を実装
- WAFルールでスティッキーセッション強制を適用
- コード変更が制限されている場合、セッション有効期限管理にWAFを使用

### 必須実装チェックリスト

1. 最小64ビットエントロピーでCSPRNGを使用してセッションIDを生成
2. Secure、HttpOnly、SameSite属性でCookieを設定
3. HSTS ヘッダーでサイト全体にHTTPSを強制
4. すべての権限変更でセッションIDを再生成
5. アイドルと絶対の両方のセッションタイムアウトを実装
6. サーバー側無効化を伴う完全なログアウト機能を提供
7. 機密コンテンツにno-storeキャッシュディレクティブを適用
8. セッション攻撃を監視しセキュリティイベントをログに記録
9. フレームワーク組み込みセッション管理を使用
10. 機密操作に再認証を要求
