---
description: 安全でない直接オブジェクト参照（IDOR）の防止
languages:
- c
- go
- java
- javascript
- kotlin
- php
- python
- ruby
- swift
- typescript
alwaysApply: false
---

## 安全でない直接オブジェクト参照（IDOR）の防止ガイドライン

このルールは、直接オブジェクト参照に対する適切なアクセス制御チェックを実装することで、IDOR脆弱性を防ぐための実行可能なガイダンスを提供します。

### 概要

安全でない直接オブジェクト参照（IDOR）は、攻撃者がWebアプリケーションのURLやパラメータで使用される識別子を操作することでオブジェクトにアクセスまたは変更できる脆弱性です。これは、ユーザーが特定のデータへのアクセスを許可されるべきかどうかを検証しないアクセス制御チェックの欠如によって発生します。

### 例

たとえば、ユーザーが自分のプロフィールにアクセスすると、アプリケーションは次のようなURLを生成する可能性があります：

```
https://example.org/users/123
```

URL内の123は、データベース内のユーザーレコードへの直接参照であり、多くの場合、主キーによって表されます。攻撃者がこの番号を124に変更して他のユーザーの情報にアクセスできる場合、アプリケーションは安全でない直接オブジェクト参照に対して脆弱です。

場合によっては、識別子はURLではなくPOSTボディに含まれることがあります：

```html
<form action="/update_profile" method="post">
  <input type="hidden" name="user_id" value="12345">
  <button type="submit">Update Profile</button>
</form>
```

この例では、攻撃者は認可なしに他のユーザーのプロフィールを変更するために"user_id"フィールドを操作できます。

### 識別子の複雑性

場合によっては、GUIDのようなより複雑な識別子を使用することで、攻撃者が有効な値を推測することを実質的に不可能にできます。しかし、複雑な識別子を使用していても、アクセス制御チェックは不可欠です。攻撃者が認可されていないオブジェクトのURLを取得した場合でも、アプリケーションはそのアクセス試行をブロックする必要があります。

### 緩和策

IDORを緩和するには、ユーザーがアクセスしようとする各オブジェクトに対してアクセス制御チェックを実装します。Webフレームワークは多くの場合、これを容易にする方法を提供しています。さらに、多層防御の手段として複雑な識別子を使用しますが、これらの識別子を使用する場合でもアクセス制御が重要であることを忘れないでください。

可能であれば、URLやPOSTボディに識別子を公開しないようにします。代わりに、セッション情報から現在認証されているユーザーを特定します。マルチステップフローを使用する場合は、改ざんを防ぐためセッション内で識別子を渡します。

主キーに基づいてオブジェクトを検索する場合は、ユーザーがアクセスできるデータセットを使用します。たとえば、Ruby on Railsでは：

```ruby
// 脆弱、すべてのプロジェクトを検索
@project = Project.find(params[:id])
// 安全、現在のユーザーに関連するプロジェクトを検索
@project = @current_user.projects.find(params[:id])
```

アクセス試行が行われるたびにユーザーの権限を検証します。Webフレームワークの推奨アプローチを使用して、これを構造的に実装します。

追加の多層防御手段として、列挙可能な数値識別子をより複雑なランダム識別子に置き換えます。これは、データベーステーブルにランダム文字列を含む列を追加し、数値主キーの代わりにURLでそれらの文字列を使用することで実現できます。もう1つの方法は、主キーとしてUUIDまたは他の長いランダム値を使用することです。識別子の暗号化は安全に行うことが難しいため避けてください。