---
description: HTML5セキュリティベストプラクティス
languages:
- c
- go
- html
- java
- javascript
- php
- python
- ruby
- typescript
- xml
alwaysApply: false
---

## HTML5セキュリティガイドライン

このルールは、モダンなWebアプリケーションにおける脆弱性を防ぐための安全なHTML5開発プラクティスについてアドバイスします。

- Webメッセージングのセキュリティ
  - postMessage呼び出しでは必ず正確なターゲットオリジンを指定し、"*"ワイルドカードは決して使用しない
  - メッセージハンドラーでevent.originを信頼できる完全なドメイン名に対して厳密に検証する
  - サブドメイン乗っ取り攻撃を許す可能性がある部分的なドメインマッチングを避ける
  - postMessageを通じて受信したすべてのデータを処理前に検証およびサニタイズする
  - メッセージデータに対してeval()やFunction()コンストラクタを決して使用しない
  - 受信したメッセージコンテンツを設定する際はinnerHTMLではなくtextContentを使用する
  - すべてのクロスオリジンメッセージデータを検証が必要な信頼されていない入力として扱う

- クロスオリジンリソース共有（CORS）のセキュリティ
  - Access-Control-Allow-Originを特定の信頼されたオリジンに制限し、"*"ワイルドカードを避ける
  - オープンリダイレクトを防ぐためXMLHttpRequest.openに渡されるURLを検証する
  - CORSを使用していてもCSRF保護を適切に実装する（CORSはCSRFを防がない）
  - 混合コンテンツリクエスト（HTTPSオリジンからのHTTPリクエスト）を拒否する
  - ブラウザ外で偽装可能なため、アクセス制御をOriginヘッダーのみに依存しない
  - 非シンプルリクエストにはプリフライトリクエストを使用し、Access-Controlヘッダーを検証する

- WebSocketのセキュリティ
  - 本番環境では安全なwss://プロトコルのみを使用し、暗号化されていないws://は決して使用しない
  - WebSocket接続にアプリケーションレベルの認証と認可を実装する
  - WebSocketハンドシェイク中にOriginヘッダーを許可リストに対して検証する
  - エラーハンドリングを含むJSON.parse()を使用してすべてのWebSocketメッセージを安全に検証および解析する
  - DoS攻撃を防ぐため接続制限とメッセージサイズ制限を実装する
  - WebSocket認証には適切な検証を伴うJWTまたは類似のトークンを使用する
  - 取り消されたアクセスのためのトークン無効化と拒否リストメカニズムを実装する

- クライアント側ストレージのセキュリティ
  - 機密データ（パスワード、トークン、APIキー、個人情報）をlocalStorageやsessionStorageに決して保存しない
  - ブラウザセッションをまたいだ永続化が不要な場合はlocalStorageの代わりにsessionStorageを使用する
  - クライアント側ストレージから取得したすべてのデータを使用前に検証およびサニタイズする
  - 絶対に必要な場合はクライアント側に保存する機密情報のデータ暗号化を実装する
  - ストレージアクセスの競合を防ぐため、同一オリジン上で複数のアプリケーションをホストすることを避ける

- DOM操作とリンクのセキュリティ
  - target="_blank"を持つすべての外部リンクにrel="noopener noreferrer"属性を追加する
  - 外部URLにwindow.open()を使用する際はwindow.opener = nullを設定する
  - 信頼できないコンテンツには最小限のパーミッションでiframe sandbox属性を使用する
  - 多層防御のためiframe sandboxと併せてX-Frame-Optionsヘッダーを実装する
  - ユーザー提供のコンテンツでinnerHTMLを避ける。textContent、createElement、または信頼できるテンプレートを使用する
  - innerHTMLを使用する必要がある場合は、DOMPurifyまたは類似のライブラリでコンテンツをサニタイズする

- 入力フィールドのセキュリティとCSRF保護
  - 機密性の高い入力フィールド（パスワード、クレジットカード、社会保障番号）にautocomplete="off"を使用する
  - 認証情報入力にspellcheck="false"、autocorrect="off"、autocapitalize="off"を追加する
  - すべての状態を変更するフォームとAJAXリクエストにCSRFトークンを実装する
  - セッションクッキーに安全なクッキー属性を使用する：HttpOnly、Secure、SameSite=Strict
  - すべてのPOST、PUT、DELETEリクエストでサーバー側のCSRFトークンを検証する

- 安全なクッキー設定
  - JavaScriptアクセスを防ぐためセッションクッキーにHttpOnlyフラグを設定する
  - クッキーがHTTPS接続でのみ送信されるようSecureフラグを使用する
  - CSRF攻撃を防ぐためSameSite=StrictまたはSameSite=Laxを実装する
  - 追加のセキュリティのため__Secure-または__Host-クッキープレフィックスを使用する
  - 適切なクッキーの有効期限とパス制限を設定する

- Web WorkersとService Workersのセキュリティ
  - Web Workersへ送信および受信するすべてのメッセージを検証する
  - ユーザー提供のURLやコンテンツからWeb Workersを決して作成しない
  - Worker通信に適切なエラーハンドリングとタイムアウトメカニズムを実装する
  - Content Security Policyを使用してWorkerスクリプトソースを制限する
  - Service Workerの登録と更新メカニズムを検証する

- 位置情報とデバイスAPIのセキュリティ
  - Geolocation APIにアクセスする前に明示的なユーザー許可を要求する
  - サーバーに送信する前に位置情報データを検証する
  - 位置情報の失敗に対する適切なエラーハンドリングを実装する
  - 位置データの傍受を防ぐため送信時はHTTPSを使用する

- オフラインアプリケーションのセキュリティ
  - アプリケーションデータをオフラインでキャッシュする前にユーザーの同意を要求する
  - キャッシュポイズニングを防ぐためキャッシュされたリソースの整合性を検証する
  - すべてのマニフェストファイルとキャッシュされたリソースにHTTPSを使用する
  - セキュリティ更新のための適切なキャッシュ無効化メカニズムを実装する

要約：
XSS、CSRF、クリックジャッキング、データ漏洩の脆弱性を防ぐため、適切なオリジン検証、安全なストレージプラクティス、CSRF保護、安全なクッキー設定、安全なDOM操作、堅牢な認証メカニズムを通じて包括的なHTML5セキュリティコントロールを実装します。