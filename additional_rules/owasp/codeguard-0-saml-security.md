---
description: SAMLセキュリティガイドライン
languages:
- java
- javascript
- python
- xml
alwaysApply: false
---

## SAMLセキュリティガイドライン

一般的な脆弱性と攻撃を防ぐため、Security Assertion Markup Language（SAML）統合を実装するための重要なセキュリティプラクティス。

### トランスポートセキュリティ

すべてのSAMLメッセージのトランスポートにTLS 1.2以降を使用し、機密性と完全性を保証します。これにより、盗聴、認証情報の盗難、ベアラートークンの盗難、メッセージの削除/変更、中間者攻撃から保護します。

### メッセージの完全性と認証

証明された鍵を使用してSAMLメッセージにデジタル署名を行い、メッセージの完全性と認証を保証します。これにより、中間者攻撃、偽造されたアサーション、メッセージの変更を防ぎます。

XMLEncを介してアサーションを暗号化し、転送後の機密属性の開示を防ぎ、ユーザー認証情報の盗難から保護します。

### プロトコル使用の検証

SAMLプロファイルの要件を厳格に遵守します。AVANTSSARチームは以下の必須要素を特定しました：

AuthnRequestの要件：
- 一意のIDとSP（Service Provider）識別子を含む必要があります
- リクエストIDはInResponseTo属性を介してレスポンスで返される必要があります

レスポンスの要件：
- 一意のID、SP識別子、IdP識別子、デジタル署名されたアサーションを含む必要があります
- InResponseToは以前に送信されたリクエストIDと一致する必要があります

認証アサーションの要件：
- ID、クライアント識別子、IdP識別子、SP識別子を含む必要があります

### XML署名セキュリティ

XML署名ラッピング攻撃を防ぎます：

スキーマ検証：
- セキュリティ目的でXMLを使用する前に、常にスキーマ検証を実行
- 検証にはローカルで信頼されたスキーマのコピーを使用
- サードパーティからの自動スキーマダウンロードを決して許可しない
- スキーマを検査し、ワイルドカードや緩いプロセッシングを無効化するよう強化

デジタル署名の検証：
- 単一の署名鍵の場合：IdPから直接取得した鍵でStaticKeySelectorを使用
- 複数の署名鍵の場合：ローカルJKSに保存された鍵でX509KeySelectorを使用
- ドキュメント内のKeyInfo要素を無視
- 異種ドキュメントの場合：信頼されたルート証明書を持つ完全なPKIX信頼モデルを実装

XML処理セキュリティ：
- 検証なしにセキュリティ要素を選択するためgetElementsByTagNameを決して使用しない
- 要素を選択するため常に絶対XPath式を使用
- 検証には強化されたスキーマを使用

### プロトコル処理ルール

すべての必要な処理ステップを検証：

AuthnRequest処理：
- すべてのSAML Core（3.4.1.4）処理ルールに従う
- 中間者攻撃を防ぐ

レスポンス処理：
- すべてのSAML Profiles（4.1.4.3）処理ルールに従う
- 盗まれたアサーション、中間者、偽造されたアサーション、ブラウザ状態の公開を防ぐ

### バインディング実装セキュリティ

HTTPリダイレクトバインディング：
- SAML Binding（3.4）仕様に従う
- メッセージを適切にエンコード/デコード

HTTPPOSTバインディング：
- SAML Binding（3.5）仕様に従う
- 盗まれたアサーションとリプレイ攻撃を避けるため、SAMLメッセージのキャッシングを防ぐ

### セキュリティ対策

追加の保護措置：

IPフィルタリング：
- 適切な場合、IPアドレスでフィルタリング
- 信頼されたパートナー向けに別のエンドポイントを提供
- 盗まれたアサーションと中間者攻撃を防ぐ

レスポンスのライフタイム：
- SAMLレスポンスに短いライフタイムを使用
- 盗まれたアサーションとブラウザ状態の公開を防ぐ

OneTimeUse：
- レスポンスをOneTimeUseとしてマーク
- ブラウザ状態の公開とリプレイ攻撃を防ぐ

### IdP起動SSOセキュリティ

非請求のレスポンスは、CSRF保護の欠如により本質的に安全性が低いです。必要な場合：

- SAML Profiles（4.1.5）検証プロセスに従う
- オープンリダイレクトを防ぐため、RelayState URLを許可リストに対して検証
- レスポンスまたはアサーションレベルで適切なリプレイ検出を実装

### Identity Providerのベストプラクティス

- アルゴリズムの互換性と暗号化強度のためX.509証明書を検証
- SAMLトークン生成に強力な認証を使用
- どのIdPがトークンを発行するか検証
- 可能な場合、信頼されたルートCAを使用
- 共通のインターネット時刻ソースに同期
- アイデンティティ検証のための保証レベルを定義
- 個人識別情報よりも非対称識別子を使用
- 個別のアサーションまたはレスポンス要素全体に署名

### Service Providerのベストプラクティス

- ユーザーのセッション状態を検証
- アサーションまたはレスポンス全体が署名されていることを確認
- 署名が認可されたIdPからのものであることを検証
- IdP証明書の有効期限と失効を検証（CRL/OCSP）
- NotBeforeとNotOnOrAfterタイムスタンプを検証
- Recipient属性を検証
- 安全なトランスポート経由でのみアサーションを交換
- セッション管理とSAMLログアウトの明確な基準を定義
- 可能な場合、SAMLアサーションからユーザーIDを検証

### 入力検証

すべてのSAML入力を信頼できない外部データとして扱う：
- すべてのSAMLプロバイダーとコンシューマーで適切な入力検証を実行
- SAMLメッセージ内のすべての要素と属性を検証
- SAMLアサーションから抽出されたデータを使用前にサニタイズ

### 暗号化要件

- すべてのSAML要素に強力な暗号化を使用
- 安全でないXMLEncアルゴリズム（RSA 1.5など）のサポートを非推奨に
- 最新の暗号解析の発展に従う
- 最新の安全な暗号化アルゴリズムのみを使用

### まとめ

安全なSAML実装には以下が必要です：
- TLS 1.2+トランスポートセキュリティとメッセージの署名および暗号化
- すべてのプロトコル要素と処理ルールの厳格な検証
- スキーマ検証と安全なXML処理を介したXML署名ラッピングに対する保護
- キャッシング防止を伴う適切なバインディング実装
- IPフィルタリング、短いライフタイム、OneTimeUseを含むセキュリティ対策
- CSRFとリプレイ保護を伴うIdP起動SSOの注意深い処理
- 強力な証明書検証とセッション管理
- 包括的な入力検証と最新の暗号化

SAMLセキュリティは、仕様に正確に従い、すべての入力を潜在的に悪意のあるものとして扱うことに依存します。
